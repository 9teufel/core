/*
---
description: Graphing/chart tool for MooTools

license: MIT License

authors:
- Brett Dixon

requires: 
- core/1.3.1: *
- more/1.3.2: Color

provides: [MilkChart.Column, MilkChart.Bar, MilkChart.Line, MilkChart.Scatter, MilkChart.Pie, MilkChart.Doughnut]

*/
(function(e){var t=e.MilkChart={};t.Colors=["#4f81bd","#c0504d","#9bbb59","#8064a2","#4198af","#db843d"];var n=new Class({initialize:function(e,t){this.x=e||0,this.y=t||0}});t.Base=new Class({Implements:[Options,Events],options:{width:480,height:290,colors:t.Colors,padding:12,font:"Verdana",fontColor:"#000000",fontSize:10,background:"#FFFFFF",chartLineColor:"#878787",chartLineWeight:1,border:!0,borderWeight:1,borderColor:"#878787",titleSize:18,titleFont:"Verdana",titleColor:"#000000",showRowNames:!0,showValues:!0,showKey:!0,useZero:!0,copy:!1,rowPrefix:"",ignoreFirstColumn:!1,clean:!1},initialize:function(e,r){this.setOptions(r),this.element=document.id(e),this.width=this.options.width,this.height=this.options.height;if(this.options.clean||!this.isClean())this.element=this.getCleanedTable();this.element.get("tag")==="table"?this.container=(new Element("div")).inject(this.element.getParent()):this.container=this.element,this.container.setStyles({width:this.width,height:this.height,display:"inline-block"}),this._canvas=(new Element("canvas",{width:this.options.width,height:this.options.height})).inject(this.container),this.ctx=this._canvas.getContext("2d"),this.data={title:this.element.title,colNames:[],rowNames:[],rows:[]},this.minY=this.options.useZero?0:1e10,this.maxY=0,this.bounds=[new n,new n(this.width,this.height)],this.chartWidth=0,this.chartHeight=0;var i=.2,s=.1;this.keyPadding=this.width*i,this.rowPadding=this.height*s,this.rowPaddingDimension="width",this.shapes=[],Object.each(t.Shapes,function(e){this.shapes.push(e)},this)},isClean:function(){var e=!0;return this.element.get("tag")==="table"&&this.element.tHead&&(e=this.element.tHead.getChildren().length===1),e},getCleanedTable:function(){var e=new Element("table"),t=(new Element("thead")).inject(e),n=(new Element("tr")).inject(t),r=(new Element("tbody")).inject(e);return this.element.getChildren()[0].getLast().getChildren().each(function(e){n.adopt(new Element("td",{text:e.get("text")}))}),this.element.getChildren()[1].getChildren().each(function(e){var e=(new Element("tr")).inject(r);e.getChildren().each(function(t){var n=new Element("td",{text:t.get("text")});e.adopt(n)})}),e.setStyle("display","none"),e.inject(this.element.getParent()),e},prepareCanvas:function(){!this.options.copy&&this.element.get("tag")=="table"&&this.element.setStyle("display","none"),this.ctx.fillStyle=this.options.background,this.ctx.fillRect(0,0,this.width,this.height),this.ctx.font=this.options.fontSize+"px "+this.options.font;if(this.options.border){var e=.5;this.ctx.strokeStyle=this.options.borderColor,this.ctx.lineWeight=this.options.borderWeight,this.ctx.strokeRect(e,e,this.width-1,this.height-1)}this.options.showValues&&(this.bounds[0].x+=this.getValueColumnWidth()),this.bounds[0].x+=this.options.padding,this.bounds[0].y+=this.options.padding,this.bounds[1].x-=this.options.padding*2,this.bounds[1].y-=this.options.padding*2;if(this.options.showKey){var t="";this.data.colNames.each(function(e){e.length>t.length&&(t=String(e))});var r=14;this.keyPadding=this.ctx.measureText(t).width+r,this.bounds[1].x-=this.keyPadding;var i=1.02;this.keyBounds=[new n(this.bounds[1].x*i,this.bounds[0].y),new n(this.keyPadding,this.bounds[1].y)]}this.chartWidth=this.bounds[1].x-this.bounds[0].x;if(this.data.title){var s=this.bounds[0].y+this.height*.1;this.bounds[0].y=s,this.titleBounds=[new n(this.bounds[0].x,0),new n(this.bounds[1].x,s)],this.drawTitle()}this.options.showRowNames?(this.ctx.font=this.options.fontSize+"px "+this.options.font,this.getRowPadding(),this.bounds[1].y-=this.rowPadding):this.rowPadding=0,this.chartHeight=this.bounds[1].y-this.bounds[0].y,this.colors=this.__getColors(this.options.colors)},getValueColumnWidth:function(){return this.ctx.measureText(String(this.maxY+.01)).width},getRowPadding:function(){var e=0;this.data.rowNames.each(function(t){e+=this.ctx.measureText(t).width},this);var t=e>this.chartWidth;t?this.rowPadding=this.ctx.measureText(this.longestRowName).width:this.rowPadding=this.ctx.measureText(this.longestRowName).width>(this.bounds[1].x-this.bounds[0].x)/this.data.rows.length?this.ctx.measureText(this.longestRowName).width:this.height*.1},drawTitle:function(){var e=1.25,t=this.options.titleSize*e;this.ctx.textAlign="center",this.ctx.font=this.options.titleSize+"px "+this.options.titleFont,this.ctx.fillStyle=this.options.titleColor,this.ctx.fillText(this.data.title,this.bounds[0].x+(this.bounds[1].x-this.bounds[0].x)/2,t,this.chartWidth)},drawAxes:function(){this.ctx.beginPath(),this.ctx.strokeStyle=this.options.chartLineColor,this.ctx.moveTo(this.bounds[0].x+.5,this.bounds[0].y+.5),this.ctx.lineTo(this.bounds[0].x+.5,this.bounds[1].y+.5),this.ctx.moveTo(this.bounds[0].x+.5,this.bounds[1].y+.5),this.ctx.lineTo(this.bounds[1].x+.5,this.bounds[1].y+.5),this.ctx.stroke()},__xAxisLabels:function(e,n,r,i){var s=0,o=t.escape(this.data.rowNames[n]),u=!0,a=4,f=Math.floor(this.data.rowNames.length*this.options.fontSize/(this.chartWidth/2));this.ctx.fillStyle=this.options.fontColor,this.ctx.lineWidth=1,this.ctx.textAlign="center",this.options.skipLabel&&(s!==0&&(u=!1),++s,s===this.options.skipLabel&&(s=0)),this.options&&this.options.labelTicks&&(this.ctx.save(),this.ctx.translate(parseInt(i.x+this.rowWidth/2)+.5,this.bounds[1].y+.5),this.ctx.moveTo(0,0),this.ctx.lineTo(0,4),this.ctx.stroke(),this.ctx.restore(),a=8);if(u===!0)if(r!==0){this.ctx.save(),this.ctx.textAlign="right";var l=i.x+this.rowWidth/2+this.options.fontSize/2,c=this.bounds[1].y+a;this.ctx.translate(l,c),this.ctx.rotate(r);if(this.data.rowNames.length*this.options.fontSize>this.chartWidth){if(this.options.skipLabel||n%f==1)this.options.type==="column"?this.ctx.fillText(o,-this.rowWidth,0):this.ctx.fillText(o,0,0)}else this.ctx.fillText(o,0,0);this.ctx.restore()}else this.ctx.fillText(o,i.x+this.rowWidth/2,this.bounds[1].y+this.rowPadding/2)},drawValueLines:function(){var e=[.1,.2,.25,.5,1,2,5,10,20,50,100,150,500,1e3,1500,2e3,2500,5e3,1e4],t=e[e.length-1];while(this.maxY>t)t+=1e4,e.push(t);var n=9,r=0;this.chartLines=1,this.maxY==this.minY&&(this.maxY=1);var i=this.maxY-this.minY,s=!1,o=0;e.each(function(e){if(s)return;for(j=n;j>4;j--){if(s)return;j*e>=i&&(s=e)}}),this.minY=Math.floor(this.minY/s)*s,this.maxY=Math.ceil(this.maxY/s)*s;for(j=this.minY;j<=this.maxY;j+=s)++o;var u=this.bounds[1].y-this.bounds[0].y,a=this.bounds[1].x-this.bounds[0].x,f=Math.floor(u/(o-1));this.ratio=f/s,this.ctx.fillStyle=this.options.fontColor;var l=this.options.rowTicks?4:0,c=0;for(j=this.minY;j<=this.maxY;j+=s){j=parseInt(j*100)/100;var h=this.bounds[1].y+.5-c*f;this.options.showValues&&(this.ctx.textAlign="right",this.ctx.fillText(String(j),this.bounds[0].x-2-l,h+3)),this.ctx.beginPath(),this.ctx.moveTo(this.bounds[0].x-l,h),this.ctx.lineTo(this.bounds[1].x,h),this.ctx.stroke(),this.ctx.moveTo(this.bounds[0].x,this.bounds[1].y+.5+j*f),++c}},swapAxes:function(){var e=this.data.rowNames.slice(0),t=this.data.colNames.slice(0);this.data.rowNames=t,this.data.colNames=e;var n=[];this.data.rows.each(function(e,t){e.each(function(e,r){n[r]||(n[r]=[]),n[r][t]=e})}),this.data.rows=n,this.setData(this.data),this.render()},setData:function(e){this.bounds=[new n,new n(this.width,this.height)],this.colors=this.__getColors(this.options.colors),this.minY=this.options.useZero?0:1e10,this.maxY=0,e.rows.each(function(e){var t=Math.max.apply(Math,e),n=Math.min.apply(Math,e);this.maxY=t>this.maxY?t:this.maxY,this.minY=n<this.minY?n:this.minY},this);var t="";e.rowNames.each(function(e){this.ctx.measureText(e).width>this.ctx.measureText(t).width&&(t=String(e))},this),this.longestRowName=t,this.data=e},load:function(e){var t=this;e=e||{};var n={method:"get",onSuccess:function(e){t.setData(e),t.render()}},r=Object.merge(e,n),i=new Request.JSON(r);return i.send(),i},getData:function(){return null},draw:function(){return null},drawKey:function(){return null},__getColors:function(e){var t=[];if(e.length==1||e.length==2){var n=new Color(e[0]),r=e.length==2?new Color(e[1]):(new Color("#ffffff")).mix(e[0],20),i=[(r[0]-n[0])/this.data.colNames.length,(r[1]-n[1])/this.data.colNames.length,(r[2]-n[2])/this.data.colNames.length],s=n;for(var o=0;o<this.data.colNames.length;o++){t.push(s.rgbToHex());for(var u=0;u<i.length;u++)s[u]+=parseInt(i[u])}}else{var a=0,f=e.slice(0);while(t.length!=this.data.colNames.length){f.length===0&&(f=e.slice(0),a+=20);var l=(new Color(f.shift())).mix("#ffffff",a);t.push(l.rgbToHex())}}return t}}),t.Column=new Class({Extends:t.Base,options:{columnBorder:!1,columnBorderWeight:2,columnBorderColor:"#ffffff",skipLabel:0,labelTicks:!1,rowTicks:!0,rotateLabels:0,type:"column"},initialize:function(e,t){this.parent(e,t),this.element.get("tag")=="table"&&(this.getData(),this.render())},render:function(){this.ctx.save(),this.prepareCanvas(),this.rowWidth=this.chartWidth/this.data.rows.length,this.drawAxes(),this.drawValueLines(),this.draw(),this.options.showKey&&this.drawKey(),this.ctx.restore()},getData:function(){this.element.getElement("thead").getChildren()[0].getChildren().each(function(e){this.data.colNames.push(e.get("html"))}.bind(this));var e="";this.element.getElement("tfoot")&&this.element.getElement("tfoot").getChildren()[0].getChildren().each(function(t){var n=t.get("html");this.data.rowNames.push(n),this.ctx.measureText(n).width>this.ctx.measureText(e).width&&(e=String(n))}.bind(this)),this.element.getElement("tbody").getChildren().each(function(e){var t=[];e.getChildren().each(function(e){var n=Number(e.get("html"));typeOf(n)||(n=e.get("html").toFloat()),t.push(n),n>this.maxY&&(this.maxY=n),n<this.minY&&(this.minY=n)}.bind(this)),this.data.rows.push(t)}.bind(this));if(!this.element.getElement("tfoot"))for(var t=1;t<=this.data.rows.length;t++){var n=this.options.rowPrefix+t;this.data.rowNames.push(n),this.ctx.measureText(n).width>e.length&&(e=String(n))}this.longestRowName=e},draw:function(){var e=this.minY>=0?this.bounds[1].y:this.bounds[1].y-Math.floor(this.chartHeight/(this.chartLines-1)),t=new n(this.bounds[0].x,e),r=Math.floor(this.rowWidth*.16),i=Math.ceil((this.rowWidth-r*2)/this.data.rows[0].length),s=this.ctx.measureText(this.longestRowName).width>this.rowWidth?-1.57079633:0,o=Math.floor(this.data.rowNames.length*this.options.fontSize/(this.chartWidth/2));this.options.rotateLabels&&(s=this.options.rotateLabels*Math.PI*-1/180),this.ctx.strokeStyle=this.options.chartLineColor,this.ctx.strokeWeight=1,this.data.rows.each(function(e,o){this.__xAxisLabels(e,o,s,t);var u=this.bounds[1].y-this.minY*this.ratio;this.minY<0&&(u=this.bounds[1].y+this.minY*this.ratio),this.minY>0&&(u=this.bounds[1].y+this.minY*this.ratio),this.minY>0&&(u=this.bounds[1].y);var a=new n(t.x,u);e.each(function(e,n){this.ctx.beginPath(),this.ctx.fillStyle=this.colors[n%this.colors.length];var s=e-this.minY,o=Math.ceil(s*this.ratio+this.minY*this.ratio)-1;this.minY>0&&(o=Math.ceil(s*this.ratio)-1),this.ctx.fillStyle=this.colors[n],this.ctx.fillRect(a.x+r,a.y-o,i,o),this.options.columnBorder&&(this.ctx.strokeStyle=this.options.columnBorderColor,this.ctx.lineWidth=this.options.columnBorderWeight,this.ctx.strokeRect(t.x+r,a.y-o,i,o)),a.x+=i}.bind(this)),t.x+=this.rowWidth}.bind(this))},drawKey:function(){var e=14,n=.06,r=Math.ceil(this.height*n),i=this.data.colNames.length*r,s=(this.height-i)/2,o=10;this.data.colNames.each(function(n,i){this.ctx.fillStyle=this.options.fontColor,this.ctx.textAlign="left",n=t.escape(n),this.ctx.fillText(n,this.keyBounds[0].x+e,s+8),this.ctx.fillStyle=this.colors[i%this.colors.length],this.ctx.fillRect(Math.ceil(this.keyBounds[0].x),Math.ceil(s),o,o),s+=r},this)}}),t.Bar=new Class({Extends:t.Column,options:{},initialize:function(e,t){this.parent(e,t)},getValueColumnWidth:function(){var e=14;return this.ctx.measureText(this.longestRowName).width+e},getRowPadding:function(){this.rowPadding=this.height*.1},drawValueLines:function(){var e=[1,2,5,10,20,50,100,150,500,1e3,1500,2e3,2500,5e3,1e4],n=e[e.length-1];while(this.maxY>n)n+=1e4,e.push(n);var r=9,i=0;this.chartLines=1;var s=Math.floor(this.maxY-this.minY);while(Math.floor(s/e[i])>r)i++;this.chartLines=Math.floor(s/e[i])+2;var o=e[i];this.ratio=this.chartWidth/((this.chartLines-1)*o),this.ctx.font=this.options.fontSize+"px "+this.options.font,this.ctx.textAlign="center",this.ctx.fillStyle=this.options.fontColor;var u=Math.ceil(this.chartWidth/(this.chartLines-1));for(i=0;i<this.chartLines;i++){this.ctx.fillStyle=this.options.fontColor;var a=this.bounds[0].x+i*u,f=this.chartLines*o-(this.chartLines-i)*o+this.minY;this.ctx.beginPath(),a=Math.round(a)+.5,this.ctx.moveTo(a,this.bounds[0].y),this.ctx.fillText(t.escape(f),a,this.bounds[1].y+14),this.ctx.lineTo(a,this.bounds[1].y+4),this.ctx.stroke()}},draw:function(){var e=new n(this.bounds[0].x,this.bounds[1].y);this.colHeight=Math.round(this.chartHeight/this.data.rows.length);var r=.16,i=Math.ceil(this.colHeight*r),s=Math.ceil((this.colHeight-i*2)/this.data.rows[0].length),o=0;this.data.rows.each(function(r,u){var a=new n(e.x,e.y),f=0;this.ctx.fillStyle=this.options.fontColor,this.ctx.textAlign="center";var l=Math.ceil(this.ctx.measureText(this.data.rowNames[o]).width);if(this.options.showRowNames){var c=t.escape(this.data.rowNames[o]);this.data.rows.length*this.options.fontSize>this.chartWidth?u%8==1&&this.ctx.fillText(c,a.x-(s+l)/2,a.y-this.rowPadding/2):this.ctx.fillText(c,a.x-(s+l)/2,a.y-this.rowPadding/2)}r.each(function(e){this.ctx.beginPath(),this.ctx.fillStyle=this.colors[f];var t=Math.ceil(e*this.ratio);this.ctx.fillRect(a.x,a.y-i,t,s),a.y-=s,f++}.bind(this)),e.y-=this.colHeight,o++}.bind(this))}}),t.Line=new Class({Extends:t.Column,options:{showTicks:!1,showLines:!0,tickSize:10,lineWeight:3,skipLabel:0,labelTicks:!1,rowTicks:!0,rotateLabels:0},load:function(e){var t=this;e=e||{};var n={noCache:!0,onSuccess:function(e){var n=[];e.rows.each(function(e,t){e.each(function(e,r){n[r]||(n[r]=[]),n[r][t]=e})}),e.rows=n,t.setData(e),t.render()},onError:function(){}},r=Object.merge(e,n),i=new Request.JSON(r);i.send()},render:function(){this.ctx.save(),this.prepareCanvas(),this.rowWidth=this.chartWidth/this.data.rows[0].length,this.drawAxes(),this.drawValueLines(),this.draw(),this.options.showKey&&this.drawKey(),this.ctx.restore()},getData:function(){this.data.rows=[],this.element.getElement("thead").getChildren()[0].getChildren().each(function(e){this.data.colNames.push(e.get("html")),this.data.rows.push([])}.bind(this));var e="";this.element.getElement("tfoot")&&this.element.getElement("tfoot").getChildren()[0].getChildren().each(function(t){var n=t.get("html");this.data.rowNames.push(n),this.ctx.measureText(n).width>e.length&&(e=String(n))}.bind(this)),this.element.getElement("tbody").getChildren().each(function(e){e.getChildren().each(function(e,t){var n=Number(e.get("html"));typeOf(n)||(n=e.get("html").toFloat()),this.data.rows[t].push(n),n>this.maxY&&(this.maxY=n),n<this.minY&&(this.minY=n)}.bind(this)),this.maxY=Math.ceil(this.maxY),this.minY=Math.floor(this.minY)}.bind(this));if(!this.element.getElement("tfoot"))for(var t=1;t<=this.element.getElement("tbody").getChildren().length;t++){var n=this.options.rowPrefix+t;this.data.rowNames.push(n),this.ctx.measureText(n).width>e.length&&(e=String(n))}this.longestRowName=e},draw:function(){this.__drawRowLabels();var e=this.bounds[1].y-this.minY*this.ratio;this.minY<0&&(e=this.bounds[1].y+this.minY*this.ratio),this.minY>0&&(e=this.bounds[1].y+this.minY*this.ratio);var r=new n(this.bounds[0].x,e),i=this.rowWidth/2,s=0,o=0,u=this.minY>=0?this.bounds[1].y+this.minY*this.ratio:this.bounds[1].y-Math.floor(this.chartHeight/(this.chartLines-1)),a=0;this.data.rows.each(function(e,f){var l;this.options.showLines&&(l=new n(r.x,r.y),this.ctx.lineWidth=this.options.lineWeight,this.ctx.beginPath(),this.ctx.strokeStyle=this.colors[f],this.ctx.moveTo(l.x+i,u-e[0]*this.ratio),e.each(function(e){var t=l.x+i,s=new n(t,r.y-e*this.ratio+.5);this.ctx.lineTo(s.x,s.y),l.x+=this.rowWidth}.bind(this)),this.ctx.stroke());if(this.options.showTicks){l=new n(r.x,r.y),a=a>Object.getLength(t.Shapes)-1?0:a;var c=this.shapes[a];e.each(function(e){var t=l.x+i,r=new n(t,u-e*this.ratio);c(this.ctx,r.x,r.y,this.options.tickSize,this.colors[f]),l.x+=this.rowWidth}.bind(this)),a++}o++,s++}.bind(this))},drawKey:function(){var e=Math.ceil(this.height*.05),n=this.data.colNames.length*e,r=(this.height-n)/2,i=0,s=25;this.data.colNames.each(function(n,o){this.ctx.fillStyle=this.options.fontColor,this.ctx.textAlign="left",this.ctx.fillText(t.escape(n),this.keyBounds[0].x+s,r+5),this.ctx.fillStyle=this.colors[o%this.colors.length],this.ctx.strokeStyle=this.colors[o%this.colors.length],this.ctx.lineWidth=3,this.options.showLines&&(this.ctx.beginPath(),this.ctx.moveTo(this.keyBounds[0].x,r+.5),this.ctx.lineTo(this.keyBounds[0].x+20,r+.5),this.ctx.closePath(),this.ctx.stroke());if(this.options.showTicks){i=i>Object.getLength(t.Shapes)-1?0:i;var u=this.shapes[i];u(this.ctx,this.keyBounds[0].x+10,r,10,this.colors[o%this.colors.length]),i++}r+=e}.bind(this))},__drawRowLabels:function(){var e=new n(this.bounds[0].x,this.bounds[1].y),t=this.ctx.measureText(this.longestRowName).width>this.rowWidth?-1.57079633:0,r=Math.floor(this.data.rowNames.length*this.options.fontSize/(this.chartWidth/2));this.options.rotateLabels&&(t=this.options.rotateLabels*Math.PI*-1/180),this.data.rowNames.each(function(n,r){this.__xAxisLabels(n,r,t,e),e.x+=this.rowWidth}.bind(this))}}),t.Scatter=new Class({Extends:t.Line,options:{showTicks:!0,showLines:!1},initialize:function(e,t){this.parent(e,t)}}),t.Pie=new Class({Extends:t.Base,options:{stroke:!0,strokeWeight:3,strokeColor:"#ffffff",chartTextColor:"#000000",shadow:!1,chartLineWeight:2,pieBorder:!1},initialize:function(e,t){this.parent(e,t),this.element.get("tag")=="table"&&(this.rowCount=this.element.getElement("thead").getChildren()[0].getChildren().length,this.colors=this.__getColors(this.options.colors),this.options.showRowNames=!1,this.getData(),this.render())},swapAxes:function(){return!0},render:function(){this.ctx.save(),this.prepareCanvas(),this.radius=this.chartHeight/2,this.options.showKey&&this.drawKey(),this.draw(),this.ctx.restore()},setData:function(e){this.bounds=[new n,new n(this.width,this.height)],this.colors=this.__getColors(this.options.colors),e.rowNames=e.colNames;var t="";e.rowNames.each(function(e){this.ctx.measureText(e).width>this.ctx.measureText(t).width&&(t=String(e))},this),this.longestRowName=t;var r=[],i=0;e.rows.each(function(e){i+=e[0]}),e.rows.each(function(e,t){var n=[e[0],e[0]/i*360];r.push(n)},this),this.pieTotal=i,e.rows=r,this.data=e},getData:function(){this.element.getElement("thead").getChildren()[0].getChildren().each(function(e){this.data.rowNames.push(e.get("html")),this.data.colNames.push(e.get("html"))}.bind(this));var e=0;this.element.getElement("tbody").getChildren()[0].getChildren().each(function(t){var n=[],r=t.get("html").toInt();n.push(r),e+=r,this.data.rows.push(n)}.bind(this)),this.data.rows.each(function(t){t.push(t[0]/e*360)}),this.pieTotal=e},draw:function(){var e=0,t=new n(this.bounds[1].x/2+this.options.padding,this.bounds[1].y/2+this.options.padding);if(this.options.shadow){var r=this.ctx.createRadialGradient(t.x,t.y,this.radius,t.x*1.03,t.y*1.03,this.radius*1.05);r.addColorStop(.5,"#000000"),r.addColorStop(.75,"#000000"),r.addColorStop(1,"rgba(0,0,0,0)"),this.ctx.fillStyle=r,this.ctx.fillRect(this.bounds[0].x,this.bounds[0].y,this.width,this.height)}this.data.rows.each(function(n,r){this.ctx.fillStyle=this.colors[r%this.colors.length],this.ctx.beginPath(),this.ctx.arc(t.x,t.y,this.radius,Math.PI/180*e,Math.PI/180*(n[1]+e),!1),this.ctx.lineTo(t.x,t.y),this.ctx.closePath(),this.ctx.fill(),this.options.stroke&&(this.ctx.strokeStyle=this.options.strokeColor,this.ctx.lineWidth=this.options.strokeWeight,this.ctx.lineJoin="round",this.ctx.beginPath(),this.ctx.arc(t.x,t.y,this.radius,Math.PI/180*e,Math.PI/180*(n[1]+e),!1),this.ctx.lineTo(t.x,t.y),this.ctx.closePath(),this.ctx.stroke());if(this.options.showValues){this.ctx.font=this.options.fontSize+"px "+this.options.font,this.ctx.fillStyle=this.options.chartTextColor,this.ctx.textAlign="center";var i=Math.PI/180*e,s=Math.PI/180*(n[1]+e),o=i+(s-i)/2,u=Math.round(n[0]/this.pieTotal*100),a=u<5?.9:1.75,f=this.radius*Math.cos(o)/a,l=this.radius*Math.sin(o)/a;this.ctx.fillText(u+"%",t.x+f,t.y+l)}e+=n[1]}.bind(this)),this.options.pieBorder&&(this.ctx.lineWidth=this.options.chartLineWeight,this.ctx.strokeStyle=this.options.chartLineColor,this.ctx.beginPath(),this.ctx.arc(t.x,t.y,this.radius-1,0,Math.PI*2),this.ctx.stroke())},drawKey:function(){var e=Math.ceil(this.height*.06),n=this.data.rowNames.length*e;n=n>this.height?this.height*.9:n;var r=(this.height-n)/2;this.ctx.font=this.options.fontSize+"px "+this.options.font,this.data.rowNames.each(function(n,i){this.ctx.fillStyle=this.options.fontColor,this.ctx.textAlign="left",this.ctx.fillText(t.escape(n),this.keyBounds[0].x+14,r+8),this.ctx.fillStyle=this.colors[i%this.colors.length],this.ctx.fillRect(Math.ceil(this.keyBounds[0].x),Math.ceil(r),10,10),r+=e}.bind(this))}}),t.Doughnut=new Class({Extends:t.Base,options:{stroke:!0,strokeWeight:1,strokeColor:"#ffffff",chartTextColor:"#000000",shadow:!1,chartLineWeight:2,pieBorder:!1},initialize:function(e,t){this.parent(e,t),this.element.get("tag")=="table"&&(this.getData(),this.rowCount=this.element.getElements("th").length,this.colors=this.__getColors(this.options.colors),this.options.showRowNames=!1,this.render())},swapAxes1:function(){return!0},render:function(){this.ctx.save(),this.prepareCanvas(),this.radius=this.chartHeight/2,this.options.showKey&&this.drawKey(),this.draw(),this.ctx.restore()},setData:function(e){this.bounds=[new n,new n(this.width,this.height)],this.colors=this.__getColors(this.options.colors);var t="";e.colNames.each(function(e){this.ctx.measureText(e).width>this.ctx.measureText(t).width&&(t=String(e))},this),this.longestRowName=t;var r=[];e.totals=[],e.rows.each(function(t,n){var i=0;t.each(function(e){i+=typeof e=="number"?e:e[0]});var s=[];t.each(function(e){var t=typeof e=="number"?e:e[0];s.push([t,t/i*360])}),r.push(s),e.totals.push(i)}),e.rows=r,this.data=e},getData:function(){this.element.getElements("th").each(function(e){this.data.colNames.push(e.get("html"))}.bind(this));var e=this.element.getElements("tbody tr");this.element.tfoot?this.element.getElement("tfoot").getChildren().getChildren().each(function(e){this.data.rowNames.push(e.get("html"))}.bind(this)):e.each(function(e,t){this.data.rowNames.push(this.options.rowPrefix+t)},this),this.data.totals=[],e.each(function(e,t){var n=0;e.getElements("td").each(function(e){n+=e.get("html").toInt()});var r=[];e.getElements("td").each(function(e){r.push([e.get("html").toInt(),e.get("html").toInt()/n*360])}),this.data.rows.push(r),this.data.totals.push(n)},this)},draw:function(){var e=0,t=new n(this.bounds[1].x/2+this.options.padding,this.bounds[1].y/2+this.options.padding),r=this.radius/2/this.data.rows.length,i=Number(this.radius);this.data.rows.each(function(n,s){n.each(function(n,r){this.ctx.fillStyle=this.colors[r%this.colors.length],this.ctx.beginPath(),this.ctx.arc(t.x,t.y,i,Math.PI/180*e,Math.PI/180*(n[1]+e),!1),this.ctx.lineTo(t.x,t.y),this.ctx.closePath(),this.ctx.fill(),this.options.stroke&&(this.ctx.strokeStyle=this.options.strokeColor,this.ctx.lineWidth=this.options.strokeWeight,this.ctx.beginPath(),this.ctx.arc(t.x,t.y,i,Math.PI/180*e,Math.PI/180*(n[1]+e),!1),this.ctx.lineTo(t.x,t.y),this.ctx.closePath(),this.ctx.stroke()),e+=n[1]},this),i-=r,e=0},this),this.ctx.beginPath(),this.ctx.fillStyle="#ffffff",this.ctx.arc(t.x,t.y,this.radius/2,0,Math.PI*2),this.ctx.fill()},drawKey:function(){var e=Math.ceil(this.height*.06),n=this.data.rowNames.length*e;n=n>this.height?this.height*.9:n;var r=(this.height-n)/2;this.ctx.font=this.options.fontSize+"px "+this.options.font,this.data.colNames.each(function(n,i){this.ctx.fillStyle=this.options.fontColor,this.ctx.textAlign="left",this.ctx.fillText(t.escape(n),this.keyBounds[0].x+14,r+8),this.ctx.fillStyle=this.colors[i%this.colors.length],this.ctx.fillRect(Math.ceil(this.keyBounds[0].x),Math.ceil(r),10,10),r+=e}.bind(this))}}),t.Shapes={square:function(e,t,n,r,i){e.fillStyle=i,e.fillRect(t-r/2,n-r/2,r,r)},circle:function(e,t,n,r,i){e.fillStyle=i,e.beginPath(),e.arc(t,n,r/2,0,Math.PI/180*360,!0),e.closePath(),e.fill()},triangle:function(e,t,r,i,s){e.fillStyle=s,e.beginPath(),t-=i/2,r-=i/2;var o=new n(t+i,r+i);e.moveTo(t,o.y),e.lineTo(t+i/2,r),e.lineTo(o.x,o.y),e.closePath(),e.fill()},cross:function(e,t,n,r,i){t-=r/2,n-=r/2,e.strokeStyle=i,e.lineWidth=r/2,e.beginPath(),e.moveTo(t,n),e.lineTo(t+r,n+r),e.moveTo(t,n+r),e.lineTo(t+r,n),e.closePath(),e.stroke()},diamond:function(e,t,n,r,i){t-=r/2,n-=r/2,e.fillStyle=i,e.beginPath(),e.moveTo(t+r/2,n),e.lineTo(t+r,n+r/2),e.lineTo(t+r/2,n+r),e.lineTo(t,n+r/2),e.closePath(),e.fill()},pipe:function(e,t,n,r,i){n-=r/2,e.strokeStyle=i,e.lineWidth=r/2,e.beginPath(),e.moveTo(t,n),e.lineTo(t,n+r),e.stroke()}},t.escape=function(e){e=String(e);var t=[[/\&amp;/g,"&"],[/\&lt;/g,"<"],[/\&gt;/g,">"]];return t.each(function(t){e=e.replace(t[0],t[1])}),e}})(window);